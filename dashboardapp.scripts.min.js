var app=angular.module("wexdashboard",["DataService","ui.router","ui.bootstrap","ui.tree","wexdashboard.directives","wexdashboard.services","angularjs-dropdown-multiselect"]);app.config(function(t,e){e.otherwise("all"),t.state("allstate",{url:"/all",templateUrl:"/AppBuilder/dashapp/src/views/dashboard/dashboardview.html",controller:"MainController"})}),app.filter("filterHtmlChars",function(){return function(t){return t.replace(/&amp;/g,"&")}}),app.controller("MainController",["$scope","$state","billingService",function(t,e,a){function r(t){vData="",dVSorter=n(t,"true");var e=dVSorter[0],a=dVSorter[1],r=dVSorter[2],o=dVSorter[3],i=[];return l(e,a),i=l(r,o),vData=i[0],vData}function o(){var t;return t=moment().format("YYYY")-1,"01/01/"+t+"-12/31/"+t}function n(t,e){var a=[],r=t.split("-"),o="",i="",n="",l="",s="";return o=moment(r[0],S),i=moment(r[1],S),(n=i.diff(o,"days"))<=31?(s=moment(o).subtract("month",1).format(S),""==e?l=s+"-"+moment(i,S).format(S):(a.push(s),a.push(moment(s).endOf("month").format(S)),a.push(moment(o,S).format(S)),a.push(moment(i,S).format(S)))):n>31&&n<=90?(s=moment(o).subtract("month",3).format(S),""==e?l=s+"-"+moment(i,S).format(S):(a.push(s),a.push(moment(s).endOf("quarter").format(S)),a.push(moment(o,S).format(S)),a.push(moment(i,S).format(S)))):(s=moment(o).subtract("year",1).format(S),""==e?l=s+"-"+moment(i,S).format(S):(a.push(s),a.push(moment(s).endOf("year").format(S)),a.push(moment(o,S).format(S)),a.push(moment(i,S).format(S)))),""==e?l:a}function l(t,e){var a="",r="",o="",i=[];return a=moment(t,S),r=moment(e,S),(o=r.diff(a,"days"))>=364&&i.push(moment(r).format("YYYY")),o<=31?i.push(moment(r).format("MMM YYYY")):o>31&&i.push(moment(r).format("[Q]Q YYYY")),i}function s(){t.sortDateKey="",t.showCountyView="",t.displayCounties="",t.billingHoursDefaultDate=n(t.billingHoursDefaultDate,t.sortDateKey),d(t.selectedstateCode,t.filterDefaultDate),u(t.selectedstateCode,t.billingHoursDefaultDate),p(t.selectedstateCode,t.billingHoursDefaultDate),D(t.selectedstateCode,t.filterDefaultDate),g(t.selectedstateCode,t.filterDefaultDate),v(t.selectedstateCode,t.filterDefaultDate),t.selectValueDisplay=r(t.filterDefaultDate)}function c(){t.selectedState=[],a.getDataForMapSelection("","state",t.filterDefaultDate).then(function(e){t.mapDataList=e,t.stateDataList=e})}function d(e,r){var o=e,i=t.selectedfilterS,n=r;a.getServiceData("state",o,i,"net_amt","firm_name",n).then(function(e){var a=d3.nest().rollup(function(t){return d3.sum(t,function(t){return t.value})}).entries(e);t.spendingHours=C(a),t.dataSpendingByBudgetLoaded=!0})}function u(e,r){var o=e,i=t.selectedfilterS,n=r;a.getServiceData("state",o,i,"hours","item_date",n).then(function(e){t.billedHours=f(e,t.filterDefaultDate),t.billcategories=m(t.billedHours),t.billedHours.reverse(),t.billcategories.reverse(),t.dataHoursBilledLoaded=!0})}function f(t,e){fData=[],dSorter=n(e,"true"),totalA=0,totalB=0;var a=dSorter[0],r=dSorter[1],o=dSorter[2],i=dSorter[3],s=[],c=[];for(var d in t)t.hasOwnProperty(d)&&(moment(t[d].name).isBetween(o,i,null,"[]")?totalA+=parseFloat(t[d].value):moment(t[d].name).isBetween(a,r,null,"[]")&&(totalB+=parseFloat(t[d].value)));return s=l(a,r),c=l(o,i),fData.push({key:s[0],y:totalB,color:"#cbcbcb"},{key:c[0],y:totalA,color:"#c31820"}),fData}function m(t){var e=[];for(var a in t)t.hasOwnProperty(a)&&e.push(t[a].key);return e}function p(e,r){var o=e,i=t.selectedfilterS,n=r;a.getServiceData("state",o,i,"anomaly_description","item_date",n).then(function(e){t.violationHours=f(e,t.filterDefaultDate),t.violationcategories=m(t.violationHours),t.violationHours.reverse(),t.violationcategories.reverse(),t.dataViolationsLoaded=!0})}function h(e){t.categories=[];for(var a in e)if(e.hasOwnProperty(a)){var r=e[a].name;t.categories.push(r)}return t.categories}function D(e,r){t.dataTrackedMattersLoaded=!1;var o=e,i=t.selectedfilterS,n=r;a.getServiceData("state",o,i,"net_amt","matter_name",n).then(function(e){t.topTrackedMatters=e.slice(0,3),h(t.topTrackedMatters),t.dataTrackedMattersLoaded=!0})}function g(e,r){t.dataTopExpendituresLoaded=!1;var o=e,i=t.selectedfilterS,n=r,l=[];a.getServiceData("state",o,i,"net_amt","firm_name",n).then(function(e){for(var a in e)l.push({name:e[a].name,value:e[a].value});var r=d3.nest().key(function(t){return t.name}).rollup(function(t){return d3.sum(t,function(t){return t.value})}).entries(l).slice(0,5);t.topStateExpenditureData=r,t.dataTopExpendituresLoaded=!0})}function v(e,r){t.dataTopAnamoliesLoaded=!1;var o=r,i=[],n="",l="";""!=e&&(n="state>>"+e+"&&"),l=t.selectedfilterS,filtersS=n+l;a.getAnomaliesData(filtersS,"anomaly_description","firm_name",o).then(function(e){for(var a in e)i.push({name:e[a].name,value:e[a].value,percentage:e[a].percentage});for(var r=i.slice(0,5),a=0;a<r.length;a++)void 0===r[a].name&&r.splice(a,1);t.topFirmAnomaliesData=r,t.dataTopAnamoliesLoaded=!0})}function b(e){return e.length>0?t.countyfieldname+">>"+y(e):""}function y(t){var e="";for(i=0;i<t.length;i++)e=e+t[i]+"||";return e}t.mapDataList=[],t.showCountyView=!1,t.resettoallstates=!0,t.selectedstateCode="",t.spendingHours="",t.billedHours="",t.spendingHours="",t.violationHours="",t.topTrackedMatters="",t.topStateExpenditureData="",t.topFirmAnomaliesData="",t.dataSpendingByBudgetLoaded=!1,t.dataHoursBilledLoaded=!1,t.dataViolationsLoaded=!1,t.dataTrackedMattersLoaded=!1,t.dataTopExpendituresLoaded=!1,t.dataTopAnamoliesLoaded=!1,t.filterDefaultDate=o(),t.billingHoursDefaultDate=o();var S="MM/DD/YYYY",C=d3.format("$,.3s");t.sortDateKey="",t.selectValueDisplay="Year";var w=function(){var t=[];for(currentYear=moment().format("YYYY"),i=0;i<6;i++){var e=new Object;for(e.id="01/01/"+(currentYear-i)+"-"+moment("01/01/"+(currentYear-i)).endOf("year").format(S),e.title=currentYear-i,e.items=[],j=1;j<12;j+=3)if(qDateStr="0"+j+"/01/"+(currentYear-i),moment().fquarter(1).start>moment(qDateStr).fquarter(1).start){var a=new Object;for(a.id=moment(moment(qDateStr).fquarter(1).start).format(S)+"-"+moment(moment(qDateStr).fquarter(1).end).format(S),a.title=moment(qDateStr).fquarter(1).toString(),a.items=[],k=j;k<j+3;k++){var r=new Object;startDateStr="",k<10?startDateStr="0"+k+"/01/"+(currentYear-i):startDateStr=k+"/01/"+(currentYear-i),r.id=moment(startDateStr).format(S)+"-"+moment(startDateStr).endOf("month").format(S),r.title=moment(startDateStr).format("MMM"),a.items.push(r)}e.items.push(a)}t.push(e)}return t}();t.list=w,t.categories=[],t.billcategories=[],t.spendingcategories=[],t.violationcategories=[],t.countyfieldname="county",t.selectedfilterS=[],t.setPeriod=function(e){""!=e&&(t.filterDefaultDate=e,t.sortDateKey="",t.selectValueDisplay="",t.billingHoursDefaultDate=n(e,t.sortDateKey),d(t.selectedstateCode,t.filterDefaultDate),u(t.selectedstateCode,t.billingHoursDefaultDate),p(t.selectedstateCode,t.billingHoursDefaultDate),D(t.selectedstateCode,t.filterDefaultDate),g(t.selectedstateCode,t.filterDefaultDate),v(t.selectedstateCode,t.filterDefaultDate),t.show_DropDown=!1,t.selectValueDisplay=r(t.filterDefaultDate))},t.resetToAllStates=function(e){t.selectedstateCode="",t.showCountyView="",t.sortDateKey="",t.selectedfilterS=[],t.countyList=[],t.mapDataList=[],t.displayCounties="",c(),d(t.selectedstateCode,t.filterDefaultDate),u(t.selectedstateCode,t.billingHoursDefaultDate),p(t.selectedstateCode,t.billingHoursDefaultDate),D(t.selectedstateCode,t.filterDefaultDate),g(t.selectedstateCode,t.filterDefaultDate),v(t.selectedstateCode,t.filterDefaultDate),t.updateMapView(t.selectedstateCode)},t.updateStateData=function(e){t.selectedfilterS=[],t.displayCounties="",t.selectedstateCode=e,t.showCountyView=!0,""==e?s():(d(t.selectedstateCode,t.filterDefaultDate),u(t.selectedstateCode,t.billingHoursDefaultDate),p(t.selectedstateCode,t.billingHoursDefaultDate),D(t.selectedstateCode,t.filterDefaultDate),g(t.selectedstateCode,t.filterDefaultDate),v(t.selectedstateCode,t.filterDefaultDate))},t.updateMapView=function(e){""!=e&&t.resettoallstates?t.resettoallstates=!0:""==e&&t.resettoallstates?t.resettoallstates=!1:""!=e||t.resettoallstates?t.resettoallstates=!1:t.resettoallstates=!0},t.updateCountyData=function(e){t.displayCounties=e.join(),t.selectedfilterS=[];var a=b(e);t.selectedfilterS=a,d(t.selectedstateCode,t.filterDefaultDate),u(t.selectedstateCode,t.billingHoursDefaultDate),p(t.selectedstateCode,t.billingHoursDefaultDate),D(t.selectedstateCode,t.filterDefaultDate),g(t.selectedstateCode,t.filterDefaultDate),v(t.selectedstateCode,t.filterDefaultDate)},s()}]),app.directive("hcBarChart",function(t){return{restrict:"EAC",replace:!0,template:'<div id="barcontainer" style="margin: 0 auto;height:250px">Loading Chart...</div>',scope:{data:"=data",cat:"="},link:function(t,e){var a=new Highcharts.chart({chart:{type:"column",renderTo:e[0],marginBottom:1,marginLeft:0,marginRight:0,marginTop:50},title:{text:""},tooltip:{formatter:function(){var t=d3.format(".3s");return this.key+":"+t(this.y)}},legend:{enabled:!1},credits:{enabled:!1},xAxis:{categories:t.cat,title:{text:null},lineWidth:0,tickWidth:0,labels:{x:-5,y:-235,align:"center",formatter:function(){var t=this.value;return'<div title="'+t+'">'+t+"</div></div>"},style:{fontWeight:"normal","font-family":"Roboto","font-size":"12px",color:"#8e8e8e"},useHTML:!0}},yAxis:{visible:!1},plotOptions:{series:{dataLabels:{enabled:!0,align:"center",color:"#FFFFFF",x:0,y:30,formatter:function(){return d3.format(".3s")(this.y)},style:{fontWeight:"normal","font-family":"Roboto","font-size":"16px"}},pointPadding:0,groupPadding:0}},series:[{maxPointWidth:100,pointPadding:0,groupPadding:0,data:t.data}]});t.$watch("data",function(e){a.series[0].setData(e,!0),a.xAxis[0].setCategories(t.cat,!0,!0)},!0)}}}),app.directive("hcHbChart",function(t){return{restrict:"EAC",replace:!0,template:'<div id="mattercontainer" style="margin: 0 auto;height:250px"><div class="loader center-block"></div></div>',scope:{data:"=",cat:"=",labelLink:"@?"},link:function(t,e){var a=new Highcharts.chart({chart:{type:"bar",renderTo:"mattercontainer"},title:{text:""},legend:{enabled:!1},credits:{enabled:!1},tooltip:{formatter:function(){return this.x+":<b>$"+Highcharts.numberFormat(Math.round(this.y))+"</b>"}},xAxis:{categories:t.cat,title:{text:null},lineWidth:0,tickWidth:0,labels:{x:0,y:-35,align:"left",formatter:function(){var e=this.value;return retStr="",t.labelLink&&(retStr='<a href="'+t.labelLink+e+'">'),retStr=retStr+'<div class="js-ellipse" title="'+e+'">',retStr+=e,retStr+="</div>",t.labelLink&&(retStr+="</a>"),retStr},useHTML:!0,style:{width:"400px"}}},yAxis:{visible:!1},plotOptions:{bar:{dataLabels:{enabled:!0,x:-70,shadow:!1,color:"#ffffff",crop:!1,overflow:"none",style:{fontWeight:"bold","font-family":"Roboto","font-size":"13px","font-weight":"normal","font-style":"normal","font-stretch":"normal","letter-spacing":"normal",color:"#ffffff","word-wrap":"break-word"},formatter:function(){return"$"+Highcharts.numberFormat(Math.round(this.y))}}}},series:[{data:t.data,color:"#c31820"}]});t.$watch("data",function(e){void 0!=e&&(a.series[0].setData(e,!0),a.xAxis[0].setCategories(t.cat,!0,!0),$(".js-ellipse").each(function(){this.parentElement.style.width="600px"}),$(".js-ellipse").each(function(){this.parentElement.style.height="600px"}),1==t.cat.length&&(a.setSize(400,120),a.xAxis[0].update({labels:{x:0,y:-35}})))},!0)}}}),app.directive("hcMap",["billingService",function(t){return{restrict:"EAC",replace:!0,scope:{dataselect:"=",itemchanged:"@",datefilter:"@"},template:'<div id="container" style="margin: 0 auto"><div class="loader center-block"></div></div>',link:function(e,a,r){function o(){$.each(i,function(t){this.drilldown=this.properties["hc-key"],postalcode=this.properties["postal-code"],mycolor="#cbcbcb",myvalue="#cbcbcb",$.each(n,function(t){postalcode==n[t].key&&(myvalue=n[t].value,mycolor="#c31820")}),this.value=myvalue,this.color=mycolor}),Highcharts.mapChart("container",{chart:{events:{drilldown:function(a){if(!a.seriesOptions){var r=this,o="countries/us/"+a.point.drilldown+"-all",n=a.point.drilldown,l=setTimeout(function(){Highcharts.maps[o]||(r.showLoading('<i class="icon-frown"></i> Failed loading '+a.point.name),l=setTimeout(function(){r.hideLoading()},1e3))},3e3);r.showLoading('<div class="loader center-block"></div>'),$.getScript("https://code.highcharts.com/mapdata/"+o+".js",function(){function s(){$.each(i,function(t){countyname=this.name,mycolor="#cbcbcb",myvalue="#cbcbcb",$.each(countydata,function(t){countyname==countydata[t].key&&(myvalue=countydata[t].value,mycolor="#c31820")}),this.value=myvalue,this.color=mycolor}),r.hideLoading(),clearTimeout(l),r.addSeriesAsDrilldown(a.point,{allowPointSelect:!0,states:{hover:{color:"#029fdb"},select:{color:"#029fdb"}},point:{events:{select:function(){var t=this.series.chart.getSelectedPoints();t.push(this);var a=[];e.$apply(function(){$.each(t,function(t,e){a.push(e.name)}),e.$parent.updateCountyData(a)})},unselect:function(){var t=this.series.chart.getSelectedPoints(),a=[];e.$apply(function(){$.each(t,function(t,e){a.push(e.name)}),e.$parent.updateCountyData(a)})}}},name:a.point.name,borderColor:"#ffffff",data:i,credits:{enabled:!1},dataLabels:{enabled:!1,format:"{point.name}"}})}i=Highcharts.geojson(Highcharts.maps[o]);var c=n.split("-");2===c.length&&(extracted=c[1]);var d="state>>"+extracted;t.getDataForMapSelection(d,"county","").then(function(t){countydata=t,s(),e.$parent.updateStateData(extracted),e.$parent.updateMapView(extracted)}),$("#countyreset").click(function(){$("#container").highcharts().series[0].data[0].select(!1)})})}},drillup:function(){}}},title:{text:""},subtitle:!1,legend:{enabled:!1},credits:{enabled:!1},colorAxis:{min:0,minColor:"#cbcbcb",maxColor:"#cbcbcb"},mapNavigation:{enabled:!0},plotOptions:{map:{states:{hover:{color:"#029fdb"},select:{color:"#c31820",borderColor:"#ffffff",dashStyle:"solid"}}}},series:[{data:i,name:"All States",borderColor:"#ffffff",dataLabels:{enabled:!1,format:"{point.properties.postal-code}"}}],drilldown:{activeDataLabelStyle:{color:"#ffffff",textDecoration:"none",textOutline:"0px #000000"},drillUpButton:{relativeTo:"spacingBox",position:{x:0,y:60}}}})}var i="";e.$watch("itemchanged",function(t,e){t!=e&&(i=Highcharts.geojson(Highcharts.maps["countries/us/us-all"]),o())},!0),i=Highcharts.geojson(Highcharts.maps["countries/us/us-all"]),small=$("#container").width()<400;var n=[];t.getDataForMapSelection("","state","").then(function(t){n=t,o()})}}}]);var DataService=angular.module("DataService",[]).service("billingService",function(t,e){function a(t){return angular.isObject(t.data)&&t.data.message?e.reject(t.data.message):e.reject("An unknown error occurred.")}function r(t){return t.data}return{getServiceData:function(e,o,i,n,l,s){return t({method:"post",url:"/AppBuilder/endpoint/getDashboardData",params:{category:e,categoryvalue:"'"+o+"'",filters:i,selectedkpi:n,subcategory:l,datefilter:s}}).then(r,a)},getAnomaliesData:function(e,o,i,n){return t({method:"post",url:"/AppBuilder/endpoint/getAnomalyNormalizedTable",data:{filters:e,selectedkpi:o,subcategory:i,datefilter:n}}).then(r,a)},getDataForMapSelection:function(e,o,i){return t({method:"post",url:"/AppBuilder/endpoint/getDashboardStates",params:{FilterValue:e,FindFieldName:o,datefilter:i}}).then(r,a)}}});